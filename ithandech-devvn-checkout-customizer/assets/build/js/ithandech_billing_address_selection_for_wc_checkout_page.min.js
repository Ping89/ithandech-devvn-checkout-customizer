jQuery(document).ready(function($){$("span.error").hide();let currentProvinceForDistrict=null;let currentDistrictForWard=null;let currentProvinceForPayment=null;let provinceDistrictData=JSON.parse(localStorage.getItem("provinceDistrictData"))||{};let wardData=JSON.parse(localStorage.getItem("wardData"))||{};let $provinceSelect=$("#address-billing_state");let $districtSelect=$("#address-billing_city");let $wardSelect=$("#address-billing_ward");function ithandechSaveCache(){localStorage.setItem("provinceDistrictData",JSON.stringify(provinceDistrictData));localStorage.setItem("wardData",JSON.stringify(wardData))}window.addEventListener("storage",function(e){if(e.key==="provinceDistrictData"){provinceDistrictData=JSON.parse(e.newValue)||{}}if(e.key==="wardData"){wardData=JSON.parse(e.newValue)||{}}});function ithandechPopulateDistrictSelect(data){$districtSelect.empty();$.each(data,function(districtCode,districtName){$districtSelect.append($("<option></option>").val(districtCode).text(districtName))});$wardSelect.empty().append($("<option></option>").val("").text("Chọn xã/phường"))}function ithandechPopulateWardSelect(data){$wardSelect.empty();$.each(data,function(wardCode,wardName){$wardSelect.append($("<option></option>").val(wardCode).text(wardName))})}function loadDistrictsByProvince(provinceCode){if(!provinceCode){$districtSelect.empty().append($("<option></option>").val("").text("Chọn quận/huyện/t.x"));$wardSelect.empty().append($("<option></option>").val("").text("Chọn xã/phường"));currentProvinceForDistrict=null;currentProvinceForPayment=null;return}currentDistrictForWard=null;$districtSelect.empty().append($("<option></option>").val("").text("Chọn quận/huyện/t.x"));$wardSelect.empty().append($("<option></option>").val("").text("Chọn xã/phường"));let billingCountry=$("#billing_country").val();if(currentProvinceForPayment!==provinceCode){if(typeof ithandechLoadPaymentMethods==="function"){ithandechLoadPaymentMethods(billingCountry,provinceCode)}currentProvinceForPayment=provinceCode}$.ajax({url:ithandech_billing_address_ajax_obj.ajaxurl,type:"POST",dataType:"json",data:{action:"ithandech_load_districts",nonce:ithandech_billing_address_ajax_obj.nonce,province_code:provinceCode},beforeSend:function(){$districtSelect.empty().append($("<option></option>").val("").text("Đang tải..."))},success:function(response){provinceDistrictData[provinceCode]={loaded:true,data:response};ithandechPopulateDistrictSelect(response);currentProvinceForDistrict=provinceCode;ithandechSaveCache();$districtSelect.trigger("click")},error:function(){alert("Không thể tải danh sách quận/huyện. Vui lòng thử lại!")}})}$provinceSelect.on("change",function(){let provinceCode=$(this).val();loadDistrictsByProvince(provinceCode)});$provinceSelect.trigger("change");function popup_address_billing_city(){let selectedProvince=$provinceSelect.val();if(!selectedProvince)return;let billingCountry=$("#billing_country").val();if(currentProvinceForPayment!==selectedProvince){if(typeof ithandechLoadPaymentMethods==="function"){ithandechLoadPaymentMethods(billingCountry,selectedProvince)}currentProvinceForPayment=selectedProvince}if(currentProvinceForDistrict!==selectedProvince){if(provinceDistrictData[selectedProvince]&&provinceDistrictData[selectedProvince].loaded){ithandechPopulateDistrictSelect(provinceDistrictData[selectedProvince].data);currentProvinceForDistrict=selectedProvince;ithandechSaveCache()}else{$.ajax({url:ithandech_billing_address_ajax_obj.ajaxurl,type:"POST",dataType:"json",data:{action:"ithandech_load_districts",province_code:selectedProvince,nonce:ithandech_billing_address_ajax_obj.nonce},beforeSend:function(){$districtSelect.empty().append($("<option></option>").val("").text("Đang tải..."));$districtSelect.select2("close")},success:function(response){provinceDistrictData[selectedProvince]={loaded:true,data:response};console.log(response.data);ithandechPopulateDistrictSelect(response);currentProvinceForDistrict=selectedProvince;ithandechSaveCache()},error:function(){alert("Không thể tải danh sách quận/huyện. Vui lòng thử lại!")}})}}}$districtSelect.on("select2:open",function(){popup_address_billing_city()});$districtSelect.on("click",function(){popup_address_billing_city();$wardSelect.trigger("click")});$districtSelect.on("change",function(){let selectedProvince=$("#address-billing_state").val();let districtCode=$(this).val();if(!districtCode){$wardSelect.empty().append($("<option></option>").val("").text("Chọn xã/phường"));currentDistrictForWard=null;return}if(wardData[selectedProvince]&&wardData[selectedProvince][districtCode]&&wardData[selectedProvince][districtCode].loaded){ithandechPopulateWardSelect(wardData[selectedProvince][districtCode].data);currentDistrictForWard=districtCode;ithandechSaveCache();$wardSelect.trigger("click")}else{$.ajax({url:ithandech_billing_address_ajax_obj.ajaxurl,type:"POST",dataType:"json",data:{action:"ithandech_load_wards",district_code:districtCode,nonce:ithandech_billing_address_ajax_obj.nonce},beforeSend:function(){$wardSelect.empty().append($("<option></option>").val("").text("Đang tải..."));$wardSelect.select2("close")},success:function(response){if(!wardData[selectedProvince]){wardData[selectedProvince]={}}wardData[selectedProvince][districtCode]={loaded:true,data:response};ithandechPopulateWardSelect(response);currentDistrictForWard=districtCode;ithandechSaveCache();$wardSelect.trigger("click")},error:function(){alert("Không thể tải danh sách xã/phường. Vui lòng thử lại!")}})}});function popup_address_billing_ward(){let selectedProvince=$provinceSelect.val();let selectedDistrict=$districtSelect.val();if(!selectedDistrict)return;if(currentDistrictForWard!==selectedDistrict){if(wardData[selectedProvince]&&wardData[selectedProvince][selectedDistrict]&&wardData[selectedProvince][selectedDistrict].loaded){ithandechPopulateWardSelect(wardData[selectedProvince][selectedDistrict].data);currentDistrictForWard=selectedDistrict;ithandechSaveCache()}else{$.ajax({url:ithandech_billing_address_ajax_obj.ajaxurl,type:"POST",dataType:"json",data:{action:"ithandech_load_wards",district_code:selectedDistrict,nonce:ithandech_billing_address_ajax_obj.nonce},beforeSend:function(){$wardSelect.empty().append($("<option></option>").val("").text("Đang tải..."))},success:function(response){if(!wardData[selectedProvince]){wardData[selectedProvince]={}}wardData[selectedProvince][selectedDistrict]={loaded:true,data:response};ithandechPopulateWardSelect(response);currentDistrictForWard=selectedDistrict;ithandechSaveCache()},error:function(){alert("Không thể tải danh sách xã/phường. Vui lòng thử lại!")}})}}}$wardSelect.on("click",function(){popup_address_billing_ward()});$wardSelect.on("select2:open",function(){popup_address_billing_ward()});$(document.body).on("checkout_error",function(){let $noticeGroup=$(".woocommerce-NoticeGroup-checkout .woocommerce-error.message-wrapper");if($noticeGroup.length){$("span.error").hide();let errorFields=[];$noticeGroup.find("li[data-id]").each(function(){let fieldId=$(this).data("id");let $field=$('[name="'+fieldId+'"]');if($field.length){$field.closest(".input-container").find("span.error").show();errorFields.push($field)}});if(errorFields.length>0){$("html, body").animate({scrollTop:errorFields[0].offset().top-50},400,function(){errorFields[0].focus()})}}});$("#billing_last_name, #billing_province_code, #billing_district_code, #billing_ward_code, #billing_address_2, #billing_phone, #billing_email").on("focus change",function(){$(this).closest(".input-container").find("span.error").hide()});function preLoadDistrictData(provinceCode){if(!provinceCode)return;if(provinceDistrictData[provinceCode]&&provinceDistrictData[provinceCode].loaded){return}$.ajax({url:ithandech_billing_address_ajax_obj.ajaxurl,type:"POST",dataType:"json",data:{action:"ithandech_load_districts",province_code:provinceCode},success:function(response){provinceDistrictData[provinceCode]={loaded:true,data:response};ithandechSaveCache()},error:function(){alert("Không thể tải danh sách quận/huyện. Vui lòng thử lại!")}})}let defaultProvinceCode=$provinceSelect.val();if(defaultProvinceCode){preLoadDistrictData(defaultProvinceCode)}let inputs=$(".woocommerce-billing-fields__field-wrapper input");inputs.on("focus",function(){$(this).closest(".wc__form-field").find("label").show()});inputs.on("blur",function(){$(this).closest(".wc__form-field").find("label").hide()});function PushMessage(notification){setTimeout(function(){notification.classList.remove("display__none");notification.classList.add("in")},100);setTimeout(function(){hideNotification(notification)},15e3);notification.addEventListener("transitionend",function(){if(!notification.classList.contains("in")){notification.classList.add("display__none")}})}function hideNotification(notification){notification.classList.remove("in");notification.classList.add("out");notification.classList.add("display__none")}function showNotifications(){const container=document.querySelector(".toast__panel-container");const hasRun=container?container.getAttribute("data-has-run-message")==="true":false;if(hasRun)return;const notifications=document.querySelectorAll(".notification");if(notifications.length>0){notifications.forEach((notification,index)=>{setTimeout(function(){PushMessage(notification)},index*1e3)});if(container){container.setAttribute("data-has-run-message","true")}}else{setTimeout(showNotifications,1e3)}}setTimeout(function(){showNotifications()},1e3);const checkoutForm=document.querySelector('form[name="checkout"]');if(checkoutForm){checkoutForm.addEventListener("submit",function(){const container=document.querySelector(".toast__panel-container");if(container){container.setAttribute("data-has-run-message","false");showNotifications()}})}$(document).on("click",".notification",function(){this.classList.add("display__none")})});